# Agent.md (プロジェクト開発・ビルド仕様書)

## プロジェクト概要
このプロジェクトは、PS2用IIDX専用コントローラ（エントリーモデル）の入力をArduino uno経由で受信し、PC(Windows)上でキーボード入力としてエミュレートするためのソフトウェアです。
レイテンシ（遅延）を極限まで削減し、ガベージコレクションによるスパイクを防ぐため、Node.jsから**Rust**へとバックエンドが完全に書き直されています。

## アーキテクチャ構成
1. **Arduino側**: 
   - `PsxControllerBitBang.h` などのライブラリを利用してPS2コントローラーの入力をPinから直接読み取ります。
   - シリアル通信（ボーレート `115200bps`）でPCへパケットを送信します。
   - 送信フォーマット例: `b:14:1` (ボタン14が押された), `b:14:0` (ボタン14が離された)
2. **PC側 (Rust / `src/main.rs`)**:
   - `serialport` クレートでシリアル通信を受信。ブロックによる遅延を防ぐため、タイムアウトは非常に短く（10ms）設定されています。
   - `enigo` クレートを用いて、仮想キーボードイベントを発行します。
   - ターンテーブル操作に紐づく特定のキー（FやRなど）に対する「一定時間後のキーリリース（離す処理）」は、`ScratchTapReleases` 構造体を用いてメインスレッドを `sleep` でブロックすることなく、イベントループ内で都度期限（`deadline`）をチェックする非同期・非ブロッキング仕様で実装されています。

## ビルド環境・手順
本プロジェクトでは、開発作業においてホスト環境（PC自体）を汚染しないよう、**Dockerを用いたクロスコンパイル環境**を利用してWindows向けビルド(`x86_64-pc-windows-gnu`)を行っています。

### 必須要件
- Dockerがインストールされており、デーモンが起動していること（Linux環境 または WSL環境推奨）。

### ビルドの実行方法
リポジトリのルートディレクトリで、用意されたシェルスクリプトを実行してください。

```bash
./build.sh
```

**スクリプトの内部動作:**
1. `Dockerfile` に基づき、`rust:1.77-slim-bookworm` をベースイメージとして `mingw-w64` (Windowsクロスコンパイル用) や `libudev-dev` 等の依存パッケージを含んだ `rust-win-builder` イメージをビルドします。
2. コンテナを起動し、カレントディレクトリをマウントした上で `cargo build --release --target x86_64-pc-windows-gnu` を実行します。
3. ビルドに成功すると、成果物としてWindows用実行ファイルがホスト側の以下のパスに出力されます。
   👉 `target/x86_64-pc-windows-gnu/release/ps2iidx_controller.exe`

## テスト検証について
ロジック（`ScratchTapReleases`のキュー管理など）の単体テストは `src/main.rs` 内の `#[cfg(test)]` モジュールに記述されています。
Linux環境等でRustツールチェーンがインストールされている場合は、以下のコマンドで回帰テストを実行できます。

```bash
cargo test
```
